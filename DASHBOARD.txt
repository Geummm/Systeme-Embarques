import streamlit as st
import pandas as pd
import io

def main():
    """
    Fonction principale de l'application Streamlit.
    Version adapt√©e pour 6 colonnes (avec Humidit√©).
    """
    
    # --- 1. Configuration de la Page ---
    st.set_page_config(
        page_title="Analyseur Datalog WWWW",
        page_icon="üõ∞Ô∏è",
        layout="wide"
    )

    # --- 2. Titre ---
    st.title("üõ∞Ô∏è Analyseur de Fichier Datalog WWWW")
    st.write("Glissez-d√©posez votre fichier `datalog.txt` ci-dessous pour l'analyser.")

    # --- 3. La zone de "Drag-and-Drop" ---
    uploaded_file = st.file_uploader(
        "Choisissez votre fichier datalog.txt",
        type=['txt']
    )

    # --- 4. Logique de Traitement ---
    if uploaded_file is None:
        # Message d'attente si aucun fichier n'est charg√©
        st.info("En attente d'un fichier...")
        st.divider()
        st.subheader("Format attendu (par ligne) :")
        # Mise √† jour de l'exemple de format
        st.code("AAAA/MM/JJ HH:MM:SS;ID;TEMP;HUM;PRESS;GPS_DATA", language="text")

    else:
        # Si un fichier est charg√©
        try:
            # --- 5. Lecture des donn√©es ---
            # Mise √† jour des noms de colonnes (6)
            noms_colonnes = ['Date/Heure', 'ID_Mesure', 'Temp√©rature', 'Humidit√©', 'Pression', 'GPS']

            df = pd.read_csv(
                uploaded_file, 
                sep=';',
                header=None,
                names=noms_colonnes,
                skipinitialspace=True,
                encoding='utf-8-sig' # G√®re les caract√®res invisibles (BOM)
            )
            
            # --- 6. Conversion des dates (ignore les erreurs) ---
            df['Timestamp_dt'] = pd.to_datetime(
                df['Date/Heure'], 
                format='%Y/%m/%d %H:%M:%S', 
                errors='coerce' # 'coerce' met NaT (Not a Time) si erreur
            )
            
            # **SIMPLIFICATION** : On supprime les lignes o√π la date est invalide
            df = df.dropna(subset=['Timestamp_dt'])
            
            if df.empty:
                st.warning("Aucune donn√©e valide n'a √©t√© trouv√©e dans le fichier.")
                return # Arr√™te le script ici

            st.success(f"Fichier '{uploaded_file.name}' charg√© ! {len(df)} lignes valides trouv√©es.")
            st.divider()

            # --- 7. Logique d'analyse GPS ---
            df_gps = df[df['GPS'] != 'GPS NA'].copy()
            df_gps = df_gps[df_gps['GPS'].notna()]
            df_map = pd.DataFrame(columns=['lat', 'lon']) # Initialiser un df vide

            if not df_gps.empty:
                try:
                    parts = df_gps['GPS'].str.split(',', expand=True)
                    if parts.shape[1] >= 4:
                        parts[0] = pd.to_numeric(parts[0], errors='coerce')
                        parts[2] = pd.to_numeric(parts[2], errors='coerce')
                        
                        df_gps['lat_val'] = parts[0]
                        df_gps['lat_hemi'] = parts[1].str.strip()
                        df_gps['lon_val'] = parts[2]
                        df_gps['lon_hemi'] = parts[3].str.strip()

                        df_gps['lat'] = df_gps['lat_val'] * df_gps['lat_hemi'].apply(lambda x: -1 if str(x) == 'S' else 1)
                        df_gps['lon'] = df_gps['lon_val'] * df_gps['lon_hemi'].apply(lambda x: -1 if str(x) == 'W' else 1)
                        
                        df_map = df_gps[['lat', 'lon']].dropna().copy()
                except Exception:
                    st.warning("Certaines donn√©es GPS n'ont pas pu √™tre analys√©es.")

            # --- 8. Affichage des Graphiques et de la Carte ---
            st.header("Graphiques des Donn√©es")
            chart_data = df.rename(columns={'Timestamp_dt': 'index'}).set_index('index')
            
            st.subheader("Temp√©rature (¬∞C)")
            st.line_chart(chart_data['Temp√©rature'])
            
            st.subheader("Humidit√© (%)")
            st.line_chart(chart_data['Humidit√©'])
            
            st.subheader("Pression (hPa)")
            st.line_chart(chart_data['Pression'])


            st.header("Carte des Points GPS")
            if not df_map.empty:
                st.map(df_map)
            else:
                st.info("Aucune donn√©e GPS valide (format 45.1,N,5.4,E) n'a √©t√© trouv√©e.")

            # --- 9. Affichage du SEUL Tableau ---
            st.header("Donn√©es Compl√®tes")
            df['Date'] = df['Timestamp_dt'].dt.date
            df['Heure'] = df['Timestamp_dt'].dt.time
            # Mise √† jour des colonnes du tableau final
            colonnes_a_afficher = ['Date', 'Heure', 'ID_Mesure', 'Temp√©rature', 'Humidit√©', 'Pression', 'GPS']
            
            # Voici le seul et unique tableau
            st.dataframe(df[colonnes_a_afficher], use_container_width=True)

        except Exception as e:
            st.error(f"Une erreur majeure est survenue : {e}")

# --- Point d'entr√©e pour lancer le script ---
if __name__ == "__main__":
    main()

